% !TeX root = ../thuthesis-example.tex
\chapter{Specification V3}
第3个版本跟TLS完全一模一样，除了random字段是特殊生成的。

\section{基本原理}
因为TLS1.3会生成KeyShare来保证此次对话是唯一的。因为random生成时加入了KeyShare，所以攻击者是无法伪装成Client或Server。

\section{random生成算法}
生成一个随机数N（16字节），通过用户输入的userIV和userPWD，使用AES\_256\_GCM对N加密。加密时，先把ClientHello和ServerHello中的random字段的32字节全部置换为0，得出Hello。

实际使用的:
\begin{itemize}
	\item 原文plainText=N
	\item 随机数iv=sha256(utf8.encode(userIV) + Hello)
	\item 密码pwd=sha256(utf8.encode(userPWD) + Hello)
	\item 附加消息additionalText=null
\end{itemize}

加密后生成出默认长度为16字节的消息认证码MAC和16字节的密文cipherText，通过拼接 cipherText + MAC 得出32字节的 FakeRandom。

\section{Server 验证}
Server 根据收到Client Hello的random来判断是否有效Client，如果不是有效Client，直接转发到伪装站。如果是有效Client，则不需转发到伪装站，使用自签证书，完整按照TLS的流程处理。

\section{Client 验证}
Client 根据收到的 Server Hello的random来判断是否有效Server，如果不是有效Server，则应表现成一个正常HTTP请求。如果是有效Server，则不需要验证证书是否有效（直接信任），最后按照正常TLS流程处理即可。
